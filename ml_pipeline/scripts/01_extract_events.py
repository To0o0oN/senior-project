import os
import glob
import librosa
import soundfile as sf
import noisereduce as nr
from tqdm import tqdm 

def merge_intervals(intervals, sr, gap_threshold):
    """ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô (Gap < threshold) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß """
    if len(intervals) == 0: return []
    merged = []
    current_start, current_end = intervals[0]
    for i in range(1, len(intervals)):
        next_start, next_end = intervals[i]
        gap_duration = (next_start - current_end) / sr
        if gap_duration < gap_threshold:
            current_end = next_end # ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏à‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        else:
            merged.append((current_start, current_end))
            current_start, current_end = next_start, next_end
    merged.append((current_start, current_end))
    return merged

def process_audio_file(input_path, output_dir, file_prefix):
    """
    ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏¥‡∏ö -> ‡∏•‡∏î Noise -> Normalize -> ‡∏´‡∏≤ Event -> ‡πÄ‡∏ã‡∏ü‡πÑ‡∏ü‡∏•‡πå‡∏¢‡πà‡∏≠‡∏¢ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á)
    """
    try:
        # 1. ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏õ‡∏£‡∏±‡∏ö Sample Rate ‡πÄ‡∏õ‡πá‡∏ô 22050 Hz ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏Å)
        y, sr = librosa.load(input_path, sr=22050)

        # 2. Noise Reduction (‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡πà‡∏≤/‡∏•‡∏°‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
        # prop_decrease=0.8 ‡∏Ñ‡∏∑‡∏≠‡∏•‡∏î noise ‡∏•‡∏á 80% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏±‡∏á‡∏û‡∏≠‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ö‡πâ‡∏≤‡∏á
        y_clean = nr.reduce_noise(y=y, sr=sr, prop_decrease=0.8)

        # 3. Normalization (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡πÄ‡∏Å‡∏• -1.0 ‡∏ñ‡∏∂‡∏á 1.0)
        y_norm = librosa.util.normalize(y_clean)

        # 4. Event Detection (‡∏´‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡∏¢‡∏ö)
        # top_db=25: ‡∏¢‡∏¥‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡∏ï‡∏±‡∏î‡πÑ‡∏ß (‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏°‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 20)
        raw_intervals = librosa.effects.split(
            y_norm,
            top_db=25,
            frame_length=2048,
            hop_length=512
        )

        merged_intervals = merge_intervals(raw_intervals, sr, gap_threshold=0.5)

        count = 1
        padding = int(sr * 0.2) # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏±‡∏ß-‡∏ó‡πâ‡∏≤‡∏¢ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞ 0.1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        for start, end in merged_intervals:
            # ‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß "‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°" ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° Padding
            if (end - start) < (sr * 0.3):
                continue

            # ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏´‡∏±‡πà‡∏ô (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á)
            start_pad = max(0, start - padding)
            end_pad = min(len(y_norm), end + padding)

            # ‡∏î‡∏∂‡∏á‡∏ó‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ
            y_event = y_norm[start_pad:end_pad]

            # ‡∏Å‡∏£‡∏≠‡∏á Event ‡∏Ç‡∏¢‡∏∞: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 0.3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡∏Ñ‡πå‡∏Å‡∏£‡∏∞‡πÅ‡∏ó‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏Å‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏±‡∏ß ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
            if len(y_event) < sr * 0.3:
                continue

            # --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏à‡∏≤‡∏Å Sample Index ---
            start_sec = start / sr
            end_sec = end / sr

            # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ-‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 65.5 -> 01-05)
            def format_time(seconds):
                m = int(seconds // 60)
                s = int(seconds % 60)
                return f"{m:02d}-{s:02d}"

            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô 00-12_00-14
            time_range = f"{format_time(start_sec)}_{format_time(end_sec)}"

            # 5. ‡πÄ‡∏ã‡∏ü‡πÑ‡∏ü‡∏•‡πå .wav ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏ô‡∏±‡πà‡∏á‡∏ü‡∏±‡∏á‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
            # ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô xc_01_001.wav
            out_filename = f"{file_prefix}_{time_range}.wav"
            out_filepath = os.path.join(output_dir, out_filename)

            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
            if os.path.exists(out_filepath):
                out_filename = f"{file_prefix}_{time_range}_{count:02d}.wav"
                out_filepath = os.path.join(output_dir, out_filename)

            sf.write(out_filepath, y_event, sr)
            count += 1
        
        return count - 1 # ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏´‡∏±‡πà‡∏ô‡πÑ‡∏î‡πâ

    except Exception as e:
        print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå {input_path}: {e}")
        return 0

def main():
    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Path ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å Root ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå)
    raw_dir = "ml_pipeline/data/01_raw"
    interim_dir = "ml_pipeline/data/02_interim"

    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    os.makedirs(raw_dir, exist_ok=True)
    os.makedirs(interim_dir, exist_ok=True)

    # ‡∏Å‡∏ß‡∏≤‡∏î‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå .wav ‡πÅ‡∏•‡∏∞ .mp3 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå 01_raw
    audio_files = glob.glob(os.path.join(raw_dir, "*.wav")) + glob.glob(os.path.join(raw_dir, "*.mp3"))

    if not audio_files:
        print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå '{raw_dir}'")
        print("üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å Xeno-canto/YouTube ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö")
        return
        
    print(f"üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏±‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ({len(audio_files)} ‡πÑ‡∏ü‡∏•‡πå)...")
    
    total_extracted = 0
    # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á Progress Bar ‡∏™‡∏ß‡∏¢‡πÜ
    for file_path in tqdm(audio_files, desc="Processing Audio"):
        # ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô q_A_XC104214_call_t_0:59)
        raw_name = os.path.splitext(os.path.basename(file_path))[0]        
        # ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏° (_t_...) ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°-‡∏à‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏´‡∏±‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á
        clean_prefix = raw_name.split("_t_")[0] if "_t_" in raw_name else raw_name

        # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á clean_prefix ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        extracted_count = process_audio_file(file_path, interim_dir, clean_prefix)
        total_extracted += extracted_count
        
    print(f"\n‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!")
    print(f"üéâ ‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {total_extracted} ‡πÑ‡∏ü‡∏•‡πå")
    print(f"üìÇ ‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ô‡∏±‡πà‡∏á‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå: {interim_dir}")

if __name__ == "__main__":
    main()
